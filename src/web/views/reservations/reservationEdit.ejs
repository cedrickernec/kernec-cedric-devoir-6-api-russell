<h1>Modification de la réservation</h1>

<% if (globalError) { %>
  <div id="globalErrorBox" data-error-type="business" class="form-global-error" role="alert">
    <%= globalError %>
  </div>
<% } %>

<div class="split-view">
  <form
    method="POST"
    action="/catways/<%= reservation.catway.number %>/reservations/<%= reservation.id %>/edit"
    class="form form--side"
    data-initial='<%- JSON.stringify({
      clientName: reservation.clientName,
      boatName: reservation.boatName,
      startDate: reservation.startDateISO,
      endDate: reservation.endDateISO
    }) %>'
  >
    <!-- ===== INFORMATIONS FIXES ===== -->
    <div class="detail-list">
      <dl class="detail-row">
        <dt>Catway</dt>
        <dd class="bold">
          #<%= reservation.catway.number %> (<%= reservation.catway.type %>)
        </dd>
      </dl>
    </div>

    <!-- ===== CLIENT ===== -->
    <div class="form-group">
      <label for="clientName">Client</label>
      <input
        type="text"
        id="clientName"
        name="clientName"
        value="<%= reservation.clientName %>"
        aria-invalid="<%= errors.clientName ? 'true' : 'false' %>"
        data-invalid="<%= errors.clientName ? 'true' : '' %>"
        required
      />
      <% if (errors?.clientName) { %>
      <p class="form-error"><%= errors.clientName %></p>
      <% } %>
    </div>

    <!-- ===== BATEAU ===== -->
    <div class="form-group">
      <label for="boatName">Nom du bateau</label>
      <input
        type="text"
        id="boatName"
        name="boatName"
        value="<%= reservation.boatName %>"
        aria-invalid="<%= errors.boatName ? 'true' : 'false' %>"
        data-invalid="<%= errors.boatName ? 'true' : '' %>"
        required
      />
      <% if (errors?.boatName) { %>
      <p class="form-error"><%= errors.boatName %></p>
      <% } %>
    </div>

    <!-- ===== DATES ===== -->
    <div class="form-group form-group--dates">
      <div class="form-group--row">
        <!-- DATE DE DÉBUT -->
        <div class="form-group">
          <label for="startDate">
            Date de début <% if (reservation.isStartDateLocked) { %>
            <i class="fa-solid fa-lock" aria-hidden="true"></i>
            <% } %>
          </label>
          <input
            type="date"
            id="startDate"
            name="startDate"
            class="<%= reservation.isStartDateLocked ? 'locked-field' : '' %>"
            value="<%= reservation.startDateISO %>"
            aria-invalid="<%= errors?.startDate ? 'true' : 'false' %>"
            data-invalid="<%= errors?.startDate ? 'true' : '' %>"
            <%= reservation.isStartDateLocked ? 'disabled aria-disabled="true"' : '' %>
          />
        </div>

        <!-- DATE DE FIN -->
        <div class="form-group">
          <label for="endDate">Date de fin</label>
          <input
            type="date"
            id="endDate"
            name="endDate"
            value="<%= reservation.endDateISO %>"
            aria-invalid="<%= errors?.endDate ? 'true' : 'false' %>"
            data-invalid="<%= errors?.endDate ? 'true' : '' %>"
            required
          />
        </div>
      </div>

      <!-- MESSAGE D’ERREUR GLOBAL (DATES) -->
      <% if (errors?.dateError) { %>
      <p class="form-error" data-error-scope="dates">
        <%= errors.dateError %>
      </p>
      <% } else if (reservation.isStartDateLocked) { %>
      <p class="form-hint muted">
        La date de début ne peut être modifiée car la réservation a commencé
      </p>
      <% } %>
    </div>


    <!-- ===== ACTIONS ===== -->
    <div class="form-actions">
      <a href="/reservations" class="btn btn-cancel"> Annuler </a>
      <button type="submit" class="btn btn-confirm" autofocus disabled>Enregistrer</button>
    </div>
  </form>

  <!-- ===== RESERVATIONS EXISTANTES (MÊME CATWAY) ===== -->
  <aside class="table-section no-gap">
    <h2>Liste des réservations existantes</h2>

    <div class="table-wrapper">
      <table class="data-table data-table--fixed">
        <caption class="sr-only">
          Liste des réservations existantes du catway
          <%= reservation.catway.number %>
          avec client, statut et période
        </caption>

        <colgroup>
          <col class="col-auto" />
          <col class="col-status" />
          <col class="col-date" />
          <col class="col-dash" />
          <col class="col-date" />
        </colgroup>

        <thead>
          <tr>
            <th scope="col" class="align-center border-col-right">Client</th>
            <th scope="col" class="align-center border-col-right">Statut</th>
            <th scope="col" class="align-center separator">Début</th>
            <th scope="col" class="align-center">&ndash;</th>
            <th scope="col" class="align-center">Fin</th>
          </tr>
        </thead>
        <tbody>
          <% if (!otherReservations || otherReservations.length === 0) { %>
          <tr>
            <td colspan="4" class="no-data">
              Aucune autre réservation existante.
            </td>
          </tr>
          <% } else { %> <% for (let i = 0; i < otherReservations.length; i++) {
          %>
          <tr>
            <td class="align-center border-col-right">
              <%= otherReservations[i].clientName %>
            </td>
            <td class="align-center border-col-left border-col-right">
              <span
                class="status <%= otherReservations[i].status.className %>"
                aria-label="<%= otherReservations[i].status.aria %>"
              >
                <%= otherReservations[i].status.label %>
              </span>
            </td>
            <td class="align-center bold">
              <%= otherReservations[i].startDateFormatted %>
            </td>
            <td class="align-center">&ndash;</td>
            <td class="align-center bold">
              <%= otherReservations[i].endDateFormatted %>
            </td>
          </tr>
          <% } %> <% } %>
        </tbody>
      </table>
    </div>
  </aside>
</div>

<!--====== SCRIPTS ======-->
<script src="/js/form/preventSubmitIfLocked.js" defer></script>
<script src="/js/ui/form/formErrorCleanup.js" defer></script>
