<% if (step === "client") { %>

<h1>Création d'une réservation</h1>

<form method="POST" action="/reservations/create" class="form">
  
  <div class="form-group <%= errors.clientName ? 'has-error' : '' %>">
    <div>
      <label for="clientName">Client</label>
      <p id="client-hint" class="form-hint muted">Prénom & Nom</p>
    </div>

    <!-- Champ affiché (lecture seul) -->
    <input
    id="clientName"
    type="text"
    name="clientName"
    value="<%= formData.clientName || '' %>"
    placeholder="John Doe"
    autocomplete="off"
    aria-describedby="client-hint"
    required
    >
    <!-- Champ envoyé au serveur -->
    <input type="hidden" name="step" value="client">
  </div>

  <div class="form-group <%= errors.boatName ? 'has-error' : '' %>">
    <div>
      <label for="boatName">Bateau</label>
      <p class="form-hint muted">Nom du bateau</p>
    </div>
    <input
      id="boatName"
      type="text"
      name="boatName"
      value="<%= formData.boatName || '' %>"
      placeholder="L'intrépide"
      autocomplete="off"
      required
    >
  </div>

  <div class="form-actions">
    <button
      type="button"
      onclick="window.location='/reservations/create/cancel'"
      class="btn btn-cancel">
      Annuler
    </button>

    <button type="submit" class="btn btn-confirm" autofocus disabled>
      Continuer
    </button>
  </div>
</form>

<% } %>

<% if (step === "dates") { %>

<h1>Création d'une réservation</h1>

<form method="POST" action="/reservations/create" class="split-view">

  <!-- CONTEXTE -->
  <input type="hidden" name="step" value="dates">
  <input type="hidden" name="clientName" value="<%= formData.clientName %>">
  <input type="hidden" name="boatName" value="<%= formData.boatName %>">

  <!-- ================= FORMULAIRE RECHERCHE ================= -->
  <section class="form form--side" aria-labelledby="search-title">
    <h2 id="search-title" class="sr-only">Recherche de disponibilité</h2>

    <div class="form-group <%= errors.date ? 'has-error' : '' %>">
      <label for="startDate">Date de début</label>
      <input
        id="startDate"
        type="date"
        name="startDate"
        value="<%= formData.startDate || '' %>"
        required
      >
    </div>

    <div class="form-group <%= errors.date ? 'has-error' : '' %>">
      <label for="endDate">Date de fin</label>
      <input
        id="endDate"
        type="date"
        name="endDate"
        value="<%= formData.endDate || '' %>"
        required
      >
      <% if (errors.date) { %>
        <p class="form-error"><%= errors.date %></p>
      <% } %>
    </div>

    <div class="form-group">
      <label for="catwayType">Type de catway</label>
      <select id="catwayType" name="catwayType">
        <option value="all"   <%= formData.catwayType === 'all' ? 'selected' : '' %>>Tous</option>
        <option value="short" <%= formData.catwayType === 'short' ? 'selected' : '' %>>Short</option>
        <option value="long"  <%= formData.catwayType === 'long' ? 'selected' : '' %>>Long</option>
      </select>
    </div>

    <div class="form-group">
      <label class="checkbox-inline">
        <input
          type="checkbox"
          name="allowPartial"
          <%= formData.allowPartial ? 'checked' : '' %>
        >
        Partiellement compatibles
      </label>
    </div>

    <div class="form-actions form-actions--split">
      <a href="/reservations/create?step=client" class="btn btn-cancel">Retour</a>
      <button
        type="submit"
        class="btn btn-confirm"
        aria-label="Lancer la recherche"
        autofocus
        disabled
        >
        <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
      </button>
    </div>
  </section>

  <!-- ================= ZONE TABLEAUX ================= -->
  <div class="split-view__right">

    <!-- ================= RÉSULTATS CATWAYS ================= -->
    <section
      id="catways-results"
      class="table-section"
      aria-hidden="false"
      aria-labelledby="results-title">

      <h2 id="results-title" class="sr-only">Résultats de recherche</h2>

      <div class="table-wrapper">

        <% if (!hasSearched) { %>
          <p class="no-data italic">Aucune recherche effectuée.</p>

        <% } else if (availableCatways.length === 0) { %>
          <p class="no-data italic">Aucun catway disponible pour la période demandée.</p>

        <% } else { %>

          <table class="data-table data-table--fixed">

            <colgroup>
              <col class="col-catway">
              <col class="col-type">
              <col class="col-status">
              <col class="col-date">
              <col class="col-dash">
              <col class="col-date">
              <col class="col-reserve">
            </colgroup>

            <thead>
              <tr>
                <th scope="col" class="align-center">Catway</th>
                <th scope="col" class="align-center">Type</th>
                <th scope="col" class="align-center border-col-left">Statut</th>
                <th scope="col" class="align-center">Du</th>
                <th scope="col" class="align-center" aria-hidden="true">&ndash;</th>
                <th scope="col" class="align-center">Au</th>
                <th scope="col" class="align-center border-col-left"></th>
              </tr>
            </thead>

            <tbody>
              <% availableCatways.forEach(c => { %>
                <tr class="<%= c.isPartial ? 'row-partial' : 'row-full' %>">

                  <td class="align-center bold"><%= c.catway.number %></td>
                  <td class="align-center"><%= c.catway.type %></td>

                  <td class="align-center border-col-left">
                    <% if (c.isFull) { %>
                      <span class="status status--ok">Disponible</span>
                    <% } else { %>
                      <span class="status status--warning">Partiel</span>
                    <% } %>
                  </td>

                  <% if (c.isFull) { %>
                    <td class="align-center"><%= c.fromFormatted %></td>
                    <td class="align-center" aria-hidden="true">&ndash;</td>
                    <td class="align-center"><%= c.toFormatted %></td>
                  <% } else { %>
                    <td
                      class="align-center muted italic"
                      colspan="3"
                      data-partial-summary="<%= c.catway.number %>"
                      data-total-slots="<%= c.slots.length %>"
                      >
                    </td>
                  <% } %>

                  <td class="align-center border-col-left">
                    <% if (c.isFull) { %>
                      <button
                        type="button"
                        class="btn btn--primary btn-toggle"
                        aria-label="Réserver le catway <%= c.catway.number %> du <%= c.fromFormatted %> au <%= c.toFormatted %>"
                        aria-pressed="false"
                        data-selection-id="<%= c.catway.number %>">
                          <span class="btn-label">Réserver</span>
                          <i class="fa-solid fa-check btn-toggle-icon btn-toggle-icon--confirm" aria-hidden="true"></i>
                          <i class="fa-solid fa-xmark btn-toggle-icon btn-toggle-icon--cancel" aria-hidden="true"></i>
                      </button>
                    <% } else { %>
                      <button
                        type="button"
                        class="btn btn-info btn-show-partials tooltip"
                        aria-describedby="tooltip-catway-<%= c.catway.number %>"
                        data-catway="<%= c.catway.number %>"
                        data-catway-type="<%= c.catway.type %>"
                        data-slots='<%= JSON.stringify(c.slots) %>'>
                        <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                        <span id="tooltip-catway-<%= c.catway.number %>" class="tooltip__content">
                          Cliquez pour afficher les créneaux disponibles
                        </span>
                      </button>
                      <% } %>
                  </td>

                </tr>
              <% }) %>
            </tbody>
          </table>

        <% } %>
      </div>
    </section>

    <!-- ================= CRÉNEAUX PARTIELS ================= -->
    <section
      id="catway-partials"
      class="table-section"
      hidden
      aria-hidden="true">

      <header class="table-header">
        <h2>Créneaux disponibles - Catway sélectionné</h2>
        <button type="button" id="back-to-results" class="btn btn--primary">
          <i class="fa-solid fa-arrow-left" aria-hidden="true"></i> Retour
        </button>
      </header>

      <div class="table-wrapper">
        <table class="data-table data-table--fixed">
          <colgroup>
            <col class="col-catway">
            <col class="col-type">
            <col class="col-status">
            <col class="col-date">
            <col class="col-dash">
            <col class="col-date">
            <col class="col-auto">
          </colgroup>
          <thead>
            <tr>
              <th class="align-center">Catway</th>
              <th class="align-center">Type</th>
              <th class="align-center border-col-left">Statut</th>
              <th class="align-center">Du</th>
              <th class="align-center">&ndash;</th>
              <th class="align-center">Au</th>
              <th class="align-center border-col-left"></th>
            </tr>
          </thead>
          <tbody id="partials-table-body"></tbody>
        </table>
      </div>
    </section>

  <!-- ================= ACTIONS POST-RECHERCHE ================= -->
  <% if (hasSearched) { %>
    <div class="form form--btn-only">

      <div class="form-group--row">
        <a href="/catways" target="_blank" class="btn btn--primary">Liste des catways</a>
        <a href="/reservations" target="_blank" class="btn btn--primary">Liste des réservations</a>
      </div>

      <div class="form-group--row">
        <button
          type="submit"
          formmethod="POST"
          formaction="/reservations/create/cancel"
          class="btn btn-cancel"
          formnovalidate
        >
          Annuler
        </button>

        <button
          type="button"
          id="validate-selection"
          class="btn btn-confirm"
          disabled>
          Valider (0)
        </button>
      </div>

    </div>
  <% } %>
  </div>
</form>

<% } %>

<!--====== SCRIPTS ======-->
<script src="/js/form/preventSubmitIfLocked.js" defer></script>
<script type="module" src="/js/table/partialsToggle.js"></script>
<script type="module" src="/js/pages/reservation/reservationSelection.js"></script>
<script src="/js/ui/form/dateRangeSync.js" defer></script>
<script src="/js/ui/form/formErrorCleanup.js" defer></script>